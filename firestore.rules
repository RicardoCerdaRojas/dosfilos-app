rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    function isFunction() {
      // Cloud Functions have special admin access
      return request.auth.token.firebase.sign_in_provider == 'custom';
    }
    
    // Check if user is super admin (for analytics dashboard)
    function isSuperAdmin() {
      return isAuthenticated() && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'super_admin';
    }
    
    function isValidSermon() {
      let sermon = request.resource.data;
      let isDraft = sermon.status == 'draft';
      return sermon.title is string &&
             sermon.title.size() >= 5 &&
             sermon.title.size() <= 200 &&
             sermon.content is string &&
             (isDraft || sermon.content.size() > 0) && // Allow empty content for drafts
             sermon.userId is string &&
             sermon.createdAt is timestamp;
    }
    
    // Sermons collection
    match /sermons/{sermonId} {
      // Allow reading individual sermons
      allow get: if isOwner(resource.data.userId) || resource.data.isShared == true || isSuperAdmin();
      
      // Allow listing/querying sermons (for collections, version history, analytics)
      // Security is enforced by requiring userId in the query itself or being super admin
      allow list: if isAuthenticated() || isSuperAdmin();
      
      allow create: if isAuthenticated() && 
                       request.auth.uid == request.resource.data.userId &&
                       isValidSermon();
      allow update: if isOwner(resource.data.userId) && isValidSermon();
      allow delete: if isOwner(resource.data.userId);
      
      // Allow super admins to read & list wizardProgress subcollection for analytics
      match /wizardProgress/{progressId} {
        allow get, list: if isOwner(get(/databases/$(database)/documents/sermons/$(sermonId)).data.userId) || isSuperAdmin();
        allow create, update, delete: if isOwner(get(/databases/$(database)/documents/sermons/$(sermonId)).data.userId);
      }
    }

    // Greek Sessions (correct collection name)
    match /greek_sessions/{sessionId} {
      // Super admins can read all sessions for analytics
      allow read: if isOwner(resource.data.userId) || isSuperAdmin();
      allow update, delete: if isOwner(resource.data.userId);
      allow create: if isAuthenticated() && request.auth.uid == request.resource.data.userId;

      match /insights/{insightId} {
        allow read, write: if isAuthenticated() && 
           get(/databases/$(database)/documents/greek_sessions/$(sessionId)).data.userId == request.auth.uid;
      }
    }

    // Greek Tutor - Passage Cache (global, reusable across users)
    // All authenticated users can read cached passages
    // All authenticated users can write (to contribute to cache)
    match /passage_cache/{passageId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }

    // Greek Tutor - Quiz Cache (hybrid caching by lemma+category)
    // All authenticated users can read and write to benefit from shared cache
    match /quiz_cache/{cacheKey} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }

    // Greek Tutor - Syntax Analysis Cache (Phase 4B)
    // Global cache for passage syntax analyses, reusable across users/sessions
    // Reduces Gemini API costs and improves latency for common passages
    match /syntax_analysis_cache/{passageId} {
      allow read: if isAuthenticated(); // All users benefit from cache
      allow create, update: if isAuthenticated(); // Anyone can populate cache
      allow delete: if false; // Cache is permanent (no deletion)
    }

    // Greek Tutor - Word Cache (Global lemma-based cache)
    // Stores gloss and grammatical category for Greek lemmata
    // Shared across all users to reduce API costs by ~50-60%
    match /greekWordCache/{cacheId} {
      allow read: if isAuthenticated(); // All users benefit from cache
      allow create, update: if isAuthenticated(); // Anyone can populate cache
      allow delete: if false; // Cache is permanent (no deletion)
    }
    
    // Users collection
    // Note: isSuperAdmin() with get() doesn't work for list operations
    // Frontend enforces role-based access control
    match /users/{userId} {
      // Allow read for authenticated users (needed for admin dashboard and Core Library)
      // Security is enforced at the application level with role checks
      allow get, list: if isAuthenticated();
      
      // Allow write for owner
      allow write: if isOwner(userId);
      
      // Allow Cloud Functions to update subscription fields
      allow update: if isFunction() && 
                       (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['subscription', 'stripeCustomerId', 'updatedAt', 'analytics', 'role', 'metadata']));
      
      // User settings subcollection (library categories, etc.)
      match /settings/{settingId} {
        allow read: if isOwner(userId);
        allow write: if isOwner(userId);
      }
      
      // Greek Tutor - Personal Insights (user's knowledge base)
      // Users can manage their own insights
      match /greek_insights/{insightId} {
        allow read: if isOwner(userId);
        allow create: if isOwner(userId) && request.resource.data.userId == userId;
        allow update: if isOwner(userId) && resource.data.userId == userId;
        allow delete: if isOwner(userId) && resource.data.userId == userId;
      }
    }
    
    // Tags collection (shared across users)
    match /tags/{tagId} {
      allow read: if isAuthenticated();
      allow write: if false; // Only created by cloud functions
    }

    // Workflow Configurations
    match /workflow_configs/{configId} {
      allow read: if isOwner(resource.data.userId);
      allow create: if isAuthenticated() && request.auth.uid == request.resource.data.userId;
      allow update: if isOwner(resource.data.userId);
      allow delete: if isOwner(resource.data.userId);
    }

    // Sermon Series collection
    match /series/{seriesId} {
      allow read: if isOwner(resource.data.userId) || isSuperAdmin();
      allow create: if isAuthenticated() && request.auth.uid == request.resource.data.userId;
      allow update: if isOwner(resource.data.userId);
      allow delete: if isOwner(resource.data.userId);
    }

    // Library Resources collection
    match /library_resources/{resourceId} {
      // Allow read for authenticated users (needed for Core Library queries with isCore filter)
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && request.auth.uid == request.resource.data.userId;
      allow update: if isOwner(resource.data.userId);
      allow delete: if isOwner(resource.data.userId);
    }

    // Document Chunks collection (for semantic search)
    // Note: read/delete rules are relaxed because batch operations need to work
    // The actual resource access is protected by library_resources rules
    match /document_chunks/{chunkId} {
      allow read: if isAuthenticated(); // Allow read for batch queries
      allow create: if isAuthenticated() && request.auth.uid == request.resource.data.userId;
      allow update: if isOwner(resource.data.userId);
      allow delete: if isAuthenticated(); // Allow delete for batch operations
    }

    // Contact Leads collection (from landing page)
    // Anyone can create a lead (for contact form)
    // Only super admin can read all leads
    match /contact_leads/{leadId} {
      allow create: if true; // Public form submission
      allow read, update, delete: if isSuperAdmin();
    }

    // Plans collection (subscription plan definitions)
    // PUBLIC READ - Landing page needs to show plans without authentication
    // Only admin or Cloud Functions can modify
    match /plans/{planId} {
      allow read: if true; // Public read for landing page
      allow write: if isFunction() || isSuperAdmin();
    }

    // Plan Translations collection (i18n for plans)
    // PUBLIC READ - Landing page needs translations without authentication
    // Only admin or Cloud Functions can modify
    match /plan_translations/{planId} {
      allow read: if true; // Public read for landing page
      allow write: if isFunction() || isSuperAdmin();
    }

    // Preaching Plans collection
    match /preaching_plans/{planId} {
      allow read: if isOwner(resource.data.userId) || isSuperAdmin();
      allow create: if isAuthenticated() && request.auth.uid == request.resource.data.userId;
      allow update: if isOwner(resource.data.userId);
      allow delete: if isOwner(resource.data.userId);
    }

    // ðŸŽ¯ Core Library Configuration (global stores metadata)
    // All authenticated users can read (to use core library)
    // Only admin can write (to create/update stores)
    match /config/coreLibraryStores {
      allow read: if isAuthenticated();
      allow write: if isSuperAdmin();
    }

    // ===========================
    // ðŸ“Š ANALYTICS COLLECTIONS
    // ===========================
    
    // Daily Metrics - Aggregated analytics data
    // Only super admins can read, only Cloud Functions can write
    match /daily_metrics/{metricId} {
      allow read: if isSuperAdmin();
      allow write: if isFunction();
    }
    
    // User Activities - User session tracking
    // Only super admins can read, only Cloud Functions can write
    match /user_activities/{activityId} {
      allow read: if isSuperAdmin();
      allow write: if isFunction();
    }
    
    // Geographic Events - Anonymous tracking allowed
    // For landing page tracking, registration, and login analytics
    match /geo_events/{eventId} {
      // Allow anonymous creation (landing page visits)
      // TODO: Add rate limiting via Cloud Function or reCAPTCHA
      allow create: if true;
      
      // Only super admins can read and delete
      allow read, delete: if isSuperAdmin();
      
      // Events are immutable - no updates allowed
      allow update: if false;
    }
    
    // ==========================================
    // EVENT-DRIVEN ANALYTICS COLLECTIONS
    // ==========================================
    
    // User Analytics - Pre-aggregated metrics per user
    match /user_analytics/{userId} {
      // Super admins can read all user analytics
      allow read: if isSuperAdmin();
      
      // Users can read their own analytics
      allow read: if isOwner(userId);
      
      // Only Cloud Functions can write
      allow write: if false;
    }
    
    // Global Metrics - Platform-wide analytics (aggregate)
    match /global_metrics/{document=**} {
      // Only super admins can read
      allow read: if isSuperAdmin();
      
      // Only Cloud Functions can write
      allow write: if false;
    }
    
    // Global Daily Metrics - Daily snapshots
    match /global_metrics_daily/{date} {
      // Only super admins can read
      allow read: if isSuperAdmin();
      
      // Only Cloud Functions can write
      allow write: if false;
    }

    // Geographic Events Collection (for analytics dashboard)
    match /geo_events/{eventId} {
      // Only super admins can read
      allow read: if isSuperAdmin();

      // Only Cloud Functions can write
      allow write: if false;
    }
  }
}
